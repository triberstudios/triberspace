<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchfab Authentication</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #2a2a2a;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .loading {
            text-align: center;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
        <p>Completing Sketchfab authentication...</p>
    </div>

    <script>
        // Handle OAuth callback response (authorization code flow)
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);

            let authCode = null;
            let error = null;
            let errorDescription = null;

            // Check for authorization code or error in query parameters
            if (urlParams.has('code')) {
                authCode = urlParams.get('code');
            }

            if (urlParams.has('error')) {
                error = urlParams.get('error');
                errorDescription = urlParams.get('error_description');
            }

            // Redirect to editor on port 3003 (editor is on different port than callback)
            const editorUrl = 'http://localhost:3003/';

            if (authCode) {
                // Exchange authorization code for access token via backend
                try {
                    const tokenResponse = await exchangeCodeForToken(authCode);
                    if (tokenResponse.success && tokenResponse.data.access_token) {
                        // Success: pass token in hash fragment
                        window.location.href = editorUrl + '#access_token=' + encodeURIComponent(tokenResponse.data.access_token) +
                            '&expires_in=' + encodeURIComponent(tokenResponse.data.expires_in || '3600') +
                            '&sketchfab_auth=success';
                    } else {
                        throw new Error(tokenResponse.message || 'No access token received');
                    }
                } catch (exchangeError) {
                    console.error('Token exchange failed:', exchangeError);
                    window.location.href = editorUrl + '#error=token_exchange_failed' +
                        '&error_description=' + encodeURIComponent(exchangeError.message) +
                        '&sketchfab_auth=error';
                }
            } else if (error) {
                // Error: pass error details
                window.location.href = editorUrl + '#error=' + encodeURIComponent(error) +
                    '&error_description=' + encodeURIComponent(errorDescription || '') +
                    '&sketchfab_auth=error';
            } else {
                // No valid response
                window.location.href = editorUrl + '#error=no_response&sketchfab_auth=error';
            }
        }

        // Exchange authorization code for access token via backend API
        async function exchangeCodeForToken(code) {
            const apiUrl = 'http://localhost:3001/api/v1/sketchfab/token';
            const redirectUri = window.location.href.split('?')[0]; // Current callback URL

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    redirect_uri: redirectUri
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Token exchange failed: ${response.status}`);
            }

            return await response.json();
        }

        // Run when page loads
        handleOAuthCallback();
    </script>
</body>
</html>